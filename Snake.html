<!DOCTYPE html>
<html>

<head>
  <script src="js/pixi.min.js"></script>
  <script src="js/graphics-extras.js"></script>
  <style></style>
</head>

<body>
  <script>

    // Set up the application
    const app = new PIXI.Application({ width: 621, height: 496, background: "#1099bb" })
    const snake = new PIXI.Graphics()
    const food = new PIXI.Graphics()
    // Initialise game components
    const snakeSize = 25;
    const foodSize = 12.5;
    var foodX
    var foodY


    const snakeBody = [];
    var Gameover = false;
    var direction = "down"


    function setupStage() {
      // Set up the game border
      const border = new PIXI.Graphics()
      border.lineStyle(5, "#000000", 1)
      border.beginFill("#1099bb")
      border.drawRect(0, 0, 505, 380)
      border.endFill()

      // Set up the container for the game
      const gameContainer = new PIXI.Container()
      gameContainer.position = { x: 50, y: 50 }
      gameContainer.width = 505
      gameContainer.height = 380

      // Render everything into the stage
      document.body.appendChild(app.view)
      gameContainer.addChild(border)
      app.stage.addChild(gameContainer)
      gameContainer.addChild(snake)
      gameContainer.addChild(food)

    }
    // Store snake body coordinate as an object
    // Snake body will be record as block number
    // X have 0-19 block and Y have 0-14 block
    function storeCoordinate(xVal, yVal, array) {
      array.push({ x: xVal, y: yVal });
    }

    function drawFood() {
      food.clear()
      foodX = Math.floor(Math.random() * 20)
      foodY = Math.floor(Math.random() * 15)
      for (let i = 0; i < snakeBody.length; i++) {
        if (snakeBody[i].x == foodX && snakeBody[i].y == foodY) {
          drawFood()
        }
      }
      food.lineStyle(0)
      food.beginFill("#2a2b2a", 1);
      food.drawStar(14.5 + foodX * 25, 15 + foodY * 25, 4, foodSize);
      food.endFill();
    }

    // Draw the snake on the stage
    function drawSnake() {
      snake.clear();
      if (snakeBody.length) {
        for (let i = 0; i < snakeBody.length; i++) {
          if (i == 0) {
            snake.beginFill("#8b0000")
            snake.drawRoundedRect(2 + snakeBody[i].x * snakeSize, 3 + snakeBody[i].y * snakeSize, snakeSize, snakeSize, 8);
            snake.endFill()
          } else {
            snake.beginFill("#2a2b2a")
            snake.drawRoundedRect(2 + snakeBody[i].x * snakeSize, 3 + snakeBody[i].y * snakeSize, snakeSize, snakeSize, 8);
            snake.endFill()
          }
        }
      }
    }

    // Update the snake position after it moves
    function updateSnake() {

      let prevX = snakeBody[0].x
      let prevY = snakeBody[0].y
      for (let i = 1; i < snakeBody.length; i++) {
        let tempX = snakeBody[i].x
        let tempY = snakeBody[i].y
        snakeBody[i].x = prevX
        snakeBody[i].y = prevY
        prevX = tempX
        prevY = tempY
      }
      switch (direction) {
        case "down":
          snakeBody[0].y += 1
          break;
        case "left":
          snakeBody[0].x -= 1
          break;
        case "right":
          snakeBody[0].x += 1
          break;
        case "up":
          snakeBody[0].y -= 1
          break;
      }
    }

    // Check whether the snake hits the wall or bites itself or gets the food
    function checkPosition() {
      if (snakeBody[0].x < 0 || snakeBody[0].x > 19 || snakeBody[0].y < 0 || snakeBody[0].y > 14) {
        Gameover = true
        console.log("Game Over")
        food.clear()
        snakeBody.length = 0
      };
      for (let i = 1; i < snakeBody.length; i++) {
        if (snakeBody[0].x == snakeBody[i].x && snakeBody[0].y == snakeBody[i].y) {
          Gameover = true
          console.log("Game Over")
          snakeBody.length = 0
          food.clear()
        }
      }
      if (Gameover == false) {
        if (snakeBody[0].x == foodX && snakeBody[0].y == foodY) {
          storeCoordinate(foodX, foodY, snakeBody)
          drawFood()
        }
      }
    }

    // Function to control the direction of the snake movement
    function onKeyDown(key) {

      // W Key is 87 and Up arrow is 38
      if (key.keyCode === 87 || key.keyCode === 38) {
        if (direction !== "down") {
          direction = "up"
        }
      }
      // S Key is 83 and Down arrow is 40
      if (key.keyCode === 83 || key.keyCode === 40) {
        if (direction !== "up") {
          direction = "down"
        }
      }
      // A Key is 65 and Left arrow is 37
      if (key.keyCode === 65 || key.keyCode === 37) {
        if (direction !== "right") {
          direction = "left"
        }
      }
      // D Key is 68 and Right arrow is 39
      if (key.keyCode === 68 || key.keyCode === 39) {
        if (direction !== "left") {
          direction = "right"
        }
      }
      // Add the 'keydown' event listener to our document
      document.removeEventListener('keydown', onKeyDown);
    }



    // Start new round of a game
    function newRound() {
      storeCoordinate(10, 4, snakeBody)
      storeCoordinate(10, 3, snakeBody)
      storeCoordinate(10, 2, snakeBody)
      storeCoordinate(10, 1, snakeBody)
      drawFood()
      let elapsed = 0.0;
      app.ticker.add((delta) => {
        elapsed += Math.round(delta)
        if (elapsed % 10 == 0 && Gameover == false) {
          // Add the 'keydown' event listener to our document
          document.addEventListener('keydown', onKeyDown);
          updateSnake()
          checkPosition()
          drawSnake()
        }
      })
    }
    setupStage()
    newRound()

  </script>
</body>

</html>